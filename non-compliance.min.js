/*
ELEMENT TO DISPAY
[
    {
        colName:<nom de la colonne>,
        destination:<id champ destinantion>,
        filters: [
            {
                column: <nom de la colonne>,
                value: <valeur attendu>,
            },
            {...},
        ],
    },
    ...
]
*/

var ID_TABLE = "table[name=TAB_DATA]";

var elements = [
    {
        colName: "ConformiteA1",
        destination: "REAPlaceurPresentArriveeAvion",
        /* filters: [
            {
                column: "Type",
                value: "DÃ©part",
            }
        ], */
    }
];

var jQueryScript = document.createElement('script');  
jQueryScript.setAttribute('src','https://cdn.jsdelivr.net/gh/alaze-gedox/alz-qse-non-compliance@main/non-compliance.min.js');
document.head.appendChild(jQueryScript);

function getColumnIndex(column) {
    var titles = [];
    $(`${ID_TABLE} thead tr th`).toArray().forEach(
        element => {titles.push(element.firstChild.nodeValue)}
    );

    index = titles.indexOf(column);
    if (index < 0) {
        throw new Error(`${column} is an invalid name`);
    }

    return index;
}

function testFilter(line, column, value) {
    return line.cells.item(getColumnIndex(column)).innerHTML === value;
}

function isNC(column, line) {
    return testFilter(line, column, "N-C");
}

function getNonCompliance(elements) {
    elements.forEach(element => {
        $(`${ID_TABLE} tbody tr`).toArray().forEach(line => {
            if (isNC(element.colName, line)) {
                if (
                    element.filters != 'undefined'
                    || element.filters.every(filter => {
                        return testFilter(line, filter.column, filter.value);
                    })
                ) {
                    var destinationField = element.destination != 'undefined' ? $(`#${element.destination}`) : $(`#${element.colName}`);
                    destinationField.val(Number(destinationField.val()) + 1);
                }
            }
        });
    });
}